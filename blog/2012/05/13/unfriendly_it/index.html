<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=author content="Wojciech Adam Koszek"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name="p:domain_verify" content=35dedfd4f697e6e974b0ae6631ca7351 /> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/1406-fonts.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/debug.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/code.css"> <script src="https://code.jquery.com/jquery-git.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-8027537-3', 'auto');
  ga('send', 'pageview');
</script> <script>
	(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
	(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
	e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
	})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
	_st('install','_i_CdLX9xwxixHZtjxHu','2.0.0');
</script> <link rel=icon type="image/png" href="/img/favicon.ico"> <title>Unfriendly IT, or how to get Perforce diffs e-mailed to you</title> <meta name=description content="I show a simple hack for getting Perforce changes e-mailed to you. "/> <meta property="og:title" content="Unfriendly IT, or how to get Perforce diffs e-mailed to you"/> <meta property="og:description" content="I show a simple hack for getting Perforce changes e-mailed to you. "/> <meta name="twitter:card" content=summary_large_image> <meta name="twitter:site" content="@wkoszek"/> <meta name="twitter:creator" content="@wkoszek"/> <meta name="twitter:title" content="Unfriendly IT, or how to get Perforce diffs e-mailed to you"/> <meta name="twitter:description" content="I show a simple hack for getting Perforce changes e-mailed to you. "/> <meta property="og:type" content=article /> <meta property="article:author" content="https://www.koszek.com/about"/> <meta property="article:publisher" content="https://www.koszek.com/"/> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> </head> <body> <div class=container> <div class="row noprint"> <div class="col-md-3 logo"> <a href="/">Wojciech Adam Koszek</a> </div> <div class="col-md-9 links hidden-sm hidden-xs"> <a class=in id=blog href="/">Blog</a> <a class=in id=reading href="/reading/">Reading</a> <a class=in id=papers href="/papers/">Papers</a> <a class=in id=about href="/about/">About me</a> <input class=st-default-search-input> </div> </div> <div class="row noprint"> <hr/> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/">Blog</a> </div> <div class=col-xs-4> <br> <a class=in href="/reading/">Reading</a> </div> <div class=col-xs-4> <br> </div> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/papers/">Papers</a> </div> <div class=col-xs-4> <br> <a class=in href="/about/">About</a> </div> <div class=col-xs-4> <br> <a class="hidden-lg hidden-md" href="#notes">Notes</a> </div> </div> <div class="row hidden-md hidden-lg links text-center noprint"> <br> <input class=st-default-search-input> </div> <div class=row> <div class="col-md-2 leftpanel hidden-xs hidden-sm"> </div> <div class="col-md-7 content"> <article> <h1 class=title>Unfriendly IT, or how to get Perforce diffs e-mailed to you</h1> <i>by Wojciech Adam Koszek</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>May 13, 2012</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>East Palo Alto, CA</i> <br/> <br/> <b>I show a simple hack for getting Perforce changes e-mailed to you. </b> <br/> <hr class=noprint /> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr class=noprint /> <div class=article_body> <p>Work for a big corporation can be very challenging sometimes. This touches me especially when I have to request something, and IT department doesn’t agree for providing me this functionality. Sometimes things are very simple, sometimes are more complex.</p> <p>In this particular case, I tried to provide myself a way to review Perforce commits other person working with me was doing. Solution, which we all know to be pretty darn good, is to have <code>diffs</code> e-mailed to you, just like we do on:</p> <p><a href="http://lists.freebsd.org">FreeBSD mailing lists</a></p> <p>But, as you already know, getting this functionality isn’t always that easy if you have The Big Brother. Most often than not, I end up crafting myself yet-another-tiny-script, that helps me a lot.</p> <p>Here it is:</p> <pre class="highlight shell"><code><span class="c">#!/bin/sh</span>
<span class="c"># vim: set tw=1000:</span>

<span class="c">#</span>
<span class="c"># You must do p4 changes &gt; ~/.p4_diff/prev before starting</span>
<span class="c"># to use this script.</span>
<span class="c">#</span>

<span class="nv">p4</span><span class="o">=</span>/home/wojciec/bin/p4

<span class="nv">dir</span><span class="o">=</span>/home/wojciec/.p4_diff/

mkdir -p <span class="nv">$dir</span>

<span class="nv">curr</span><span class="o">=</span><span class="nv">$dir</span>/curr
<span class="nv">prev</span><span class="o">=</span><span class="nv">$dir</span>/prev

<span class="nv">$p4</span> changes &gt; <span class="nv">$curr</span>

diff <span class="nv">$prev</span> <span class="nv">$curr</span> 2&gt;&amp;1 &gt; /dev/null
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span>; <span class="k">then</span>
	<span class="c"># no new commits.</span>
	<span class="nb">echo</span> <span class="s2">"P4DIFF: no commits"</span>;
	<span class="nb">exit </span>0;
<span class="k">fi</span>

<span class="c">#Fool-proof stuff</span>
<span class="nv">DIFF_NUM</span><span class="o">=</span><span class="sb">`</span>diff -u <span class="nv">$prev</span> <span class="nv">$curr</span> | wc -l | cut -d <span class="s2">" "</span> -f 1<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$DIFF_NUM</span> -gt 25 <span class="o">]</span>; <span class="k">then
	</span><span class="nb">echo</span> <span class="s2">"P4DIFF: something is wrong with metadata: &gt; 25 commits in 5 mins?"</span>;
	<span class="nb">exit</span>;
<span class="k">fi

</span>diff -u <span class="nv">$prev</span> <span class="nv">$curr</span> | grep <span class="s1">'^+C'</span> | <span class="k">while </span><span class="nb">read </span>DIFF_LINE; <span class="k">do
	</span><span class="nv">CHANGE_NUM</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$DIFF_LINE</span> | cut -d <span class="s2">" "</span> -f 2<span class="sb">`</span>
	<span class="nv">SUBJECT</span><span class="o">=</span><span class="s2">"P4DIFF </span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$DIFF_LINE</span> | sed <span class="s1">'s/^+//'</span> | cut -d <span class="s2">" "</span> -f 2,6-<span class="sb">`</span><span class="s2">"</span>

	<span class="nb">echo</span> <span class="s2">"DIFF_LINE      : </span><span class="nv">$DIFF_LINE</span><span class="s2">"</span>
	<span class="nb">echo</span> <span class="s2">"SUBJECT:       : </span><span class="nv">$SUBJECT</span><span class="s2">"</span>;
	<span class="nb">echo</span> <span class="s2">"CHANGE_NUM     : </span><span class="nv">$CHANGE_NUM</span><span class="s2">"</span>;

	<span class="nv">$p4</span> describe -du <span class="nv">$CHANGE_NUM</span> | mail -s <span class="s2">"</span><span class="nv">$SUBJECT</span><span class="s2">"</span> wojciec
<span class="k">done
</span>cp <span class="nv">$curr</span> <span class="nv">$prev</span>
</code></pre> <p>I purposefully didn’t fix it, so that you understand what you’re doing (hint: read the comment). Cron job with this script will produce some junk on the output and will get e-mailed to you. I prefer that – I have a e-mail filter dumping these e-mails to a separate e-mail folders under CRON/ directory, so that I can inspect things going wrong.</p> <p>PS: This post doesn’t solve “How to keep your Perforce session opened”, but I’m not brave enough to show it to you, so this is that part you have to figure out by yourself.</p> <p>Script turned out to be pretty useful. I can see from Perforce what sort of problems hardware group is solving!</p> </div> </article> <div class="row noprint"> <br> <div class="col-md-6 text-left"> </div> <div class="col-md-6 text-right"> </div> </div> <div class=noprint> <hr> <h3 id=mailing-list>Subscribe for updates</h3> <p> Once a month I send updates on the new content and hints for software engineers. <div id=mc_embed_signup class=row> <form action="//koszek.us3.list-manage.com/subscribe/post?u=0cfe70aa4cdf848b2adbd70c6&amp;id=bc454f0778" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll class=col-md-12> <input type=email value="" name=EMAIL class="required email" id=mce-EMAIL placeholder="Enter E-mail here"> <div id=mce-responses class=clear> <div class=response id=mce-error-response style="display:none"></div> <div class=response id=mce-success-response style="display:none"></div> </div> <div style="position: absolute; left: -5000px;"><input name=b_0cfe70aa4cdf848b2adbd70c6_bc454f0778 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button width="100%"></div> </div> </form> </div> </p> <hr> <b>Liked it? Share it!</b> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr> <p><br/> <strong>About the author:</strong> I’m Wojciech Adam Koszek. I like software, business and design. Poland native. In Bay Area since 2010.   <a href="/about/">More about me…</a></p> <hr> <div id=disqus_thread></div> <script>

var disqus_config = function () {
this.page.url = document.location.href.split('?')[0].split('#')[0];
this.page.identifier = this.page.url;
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//koszek.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> <div class=col-md-1> </div> <div class="col-md-2 rightpanel noprint"> <iframe src="http://rcm-na.amazon-adsystem.com/e/cm?lt1=_blank&bc1=FFFFFF&IS2=1&npa=1&bg1=FFFFFF&fc1=000000&lc1=FF0000&t=wkoszek-20&o=1&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=0596101856" style="width:120px;height:240px;" scrolling=no marginwidth=0 marginheight=0 frameborder=0></iframe> <br> <br> <br><h4>Mailing list</h4> <a href="#mailing-list">Subscribe</a> <br><h4>RSS feed</h4> <a href="http://www.koszek.com/feed.xml">RSS</a> <h4>Contact</h4> <a href="mailto:wojciech@koszek.com">E-mail</a><br> <a href="https://twitter.com/wkoszek/">Twitter</a><br> <a href="https://www.linkedin.com/in/wkoszek/">LinkedIn</a><br> <a href="https://github.com/wkoszek/">Github</a><br> <h4>Tags</h4> <span class=tag> <a href="/blog/tags/software-engineering">software engineering</a> </span> <br> <span class=tag> <a href="/blog/tags/tools">tools</a> </span> <br> <span class=tag> <a href="/blog/tags/entrepreneurship">entrepreneurship</a> </span> <br> <span class=tag> <a href="/blog/tags/productivity">productivity</a> </span> <br> </div> </div> <div class="row noprint"> <div class="col-md-12 footer"> <i>&copy;&nbsp;2012&dash;2017 Wojciech Adam Koszek (<a href="https://www.twitter.com/wkoszek/">@wkoszek</a>)</i> <br> Visits so far: <script>
var sc_project=10468040; 
var sc_invisible=0; 
var sc_security="b542d462"; 
var sc_text=2; 
var scJsHost = (("https:" == document.location.protocol) ?  "https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost+ "statcounter.com/counter/counter.js'></"+"script>");
</script> <noscript> <div class=statcounter> <a title="free web stats" href="https://statcounter.com/free-web-stats/" target=_blank> <img class=statcounter src="https://c.statcounter.com/10468040/0/b542d462/0/" alt="free web stats"/></a> </div> </noscript> </div> </div> </div> <script>
        var active_page_elem = document.getElementById('active_page_name')
        var active_page_name = (active_page_elem != null ? active_page_elem.textContent : "blog");
        var active_page_link = document.getElementById(active_page_name);
        active_page_link.className = "ac";
    </script> </body> </html>
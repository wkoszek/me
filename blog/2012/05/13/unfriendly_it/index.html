<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
		<meta name="author" content="Wojciech Adam Koszek">
		<meta name="description" content="Wojciech Adam Koszek website and blog">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

		<link rel="stylesheet" href="/css/normalize.css">
		<link rel="stylesheet" href="/css/skeleton.css">
		<link rel="stylesheet" href="/css/debug.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

		<link rel="icon" type="image/png" href="images/favicon.png">
		<title>Blog Title - Unfriendly IT, or how to get Perforce diffs e-mailed to you</title>
		<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
	</head>
	<body>
	<div class="container">
		<div class="row">
			<div id="debug">
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
			</div>
		</div>

		<div class="row">
			<div class="three columns logo">
				<a href="/">Wojciech Adam Koszek</a>
			</div>
			<div class="eight columns links">
				<a class="in" href="/">Writing</a>
				<a class="in" href="/reading/">Reading</a>
				<a class="in" href="/speaking/">Speaking</a>
				<a class="in" href="/software/">Software</a>
				<a class="in" href="/about/">About me</a>
			</div>
		</div>
		<div class="row">
			<div class="twelve columns">
				<br>
				<br>
			</div>
		</div>

		<div class="row"><!-- center -->
			<div class="three columns leftpanel">
				<div class="ads">
				</div>

				<b>Contact</b><br>
				<a href="mailto:wojciech@koszek.com"><i class="fa fa-envelope-o"></i>&nbsp;&nbsp;wojciech@koszek.com</a>
				<br>

				<a href="http://www.twitter.com/wkoszek/"><i class="fa fa-twitter"></i>&nbsp;&nbsp;@wkoszek</a>
				<br>

				<a href="http://www.linkedin.com/in/wkoszek/"><i class="fa fa-linkedin"></i>&nbsp;&nbsp;LinkedIn</a>
				<br>

				<a href="http://www.github.com/wkoszek/"><i class="fa fa-github"></i>&nbsp;&nbsp;Github</a>
				<br>

				<br>
				<b>Tags</b>
				<br>
					<a href="/blog/tags/books/">books (2)</a><br>
			</div>
			<div class="seven columns content">
				<p>Work for a big corporation can be very depressing sometimes. This touches me
especially when I have to request something, and IT department doesn't
agree for providing me this functionality. Sometimes things are very simple,
sometimes are more complex.</p>

<p>Sometimes no time is the problem, sometimes "My request is not important
enough to dedicate time for it". Sometimes I don't know how to push my
company further. For now I've just set a "15 business days reminder". We'll
see.</p>

<p>In this particular case, I tried to provide myself a way to review Perforce
commits other person working with me was doing. Solution, which we all know to
be pretty darn good, is to have <code>diffs</code> e-mailed to you, just like we do on:</p>

<p><a href="http://lists.freebsd.org">FreeBSD mailing lists</a></p>

<p>But, as you already know, getting this functionality isn't always that easy
if you have The Big Brother. Most often than not, I end up crafting myself
yet-another-tiny-script, that helps me a lot.</p>

<p>Here it is:</p>

<pre><code>#!/bin/sh
# vim: set tw=1000:

#
# You must do p4 changes &gt; ~/.p4_diff/prev before starting
# to use this script.
#

p4=/home/wojciec/bin/p4

dir=/home/wojciec/.p4_diff/

mkdir -p $dir

curr=$dir/curr
prev=$dir/prev

$p4 changes &gt; $curr

diff $prev $curr 2&gt;&amp;1 &gt; /dev/null
if [ $? -eq 0 ]; then
	# no new commits.
	echo "P4DIFF: no commits";
	exit 0;
fi

#Fool-proof stuff
DIFF_NUM=`diff -u $prev $curr | wc -l | cut -d " " -f 1`
if [ $DIFF_NUM -gt 25 ]; then
	echo "P4DIFF: something is wrong with metadata: &gt; 25 commits in 5 mins?";
	exit;
fi

diff -u $prev $curr | grep '^+C' | while read DIFF_LINE; do
	CHANGE_NUM=`echo $DIFF_LINE | cut -d " " -f 2`
	SUBJECT="P4DIFF `echo $DIFF_LINE | sed 's/^+//' | cut -d " " -f 2,6-`"

	echo "DIFF_LINE      : $DIFF_LINE"
	echo "SUBJECT:       : $SUBJECT";
	echo "CHANGE_NUM     : $CHANGE_NUM";

	$p4 describe -du $CHANGE_NUM | mail -s "$SUBJECT" wojciec
done
cp $curr $prev
</code></pre>

<p>I purposefully didn't fix it, so that you understand what you're doing
(hint: read the comment). Cron job with this script will produce some junk
on the output and will get e-mailed to you. I prefer that  â€“ I have a
e-mail filter dumping these e-mails to a separate e-mail folders under CRON/
directory, so that I can inspect things going wrong.</p>

<p>PS: This post doesn't solve "How to keep your Perforce session opened", but
    I'm not brave enough to show it to you, so this is that part you have to
    figure out by yourself.</p>

<p>Script turned out to be pretty useful. I can see from Perforce what sort of
problems hardware group is solving!
@@@RIGHT@@@</p>

<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&amp;bc1=FFFFFF&amp;IS2=1&amp;npa=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=FF0000&amp;t=wojcadamkoszh-20&amp;o=1&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=0596101856" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

			</div>

			<div class="two columns">
			</div>
		</div><!-- content -->

		<div class="row footer">
			<div class="twelve columns">
			<center>
				&copy; 2015 Wojciech Adam Koszek
			</center>
			</div>
		</div>
	</div><!--container-->
</body>
</html>

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
		<meta name="author" content="Wojciech Adam Koszek">
		<meta name="description" content="Wojciech Adam Koszek website and blog">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

		<link rel="stylesheet" href="/css/normalize.css">
		<link rel="stylesheet" href="/css/skeleton.css">
		<link rel="stylesheet" href="/css/debug.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

		<link rel="icon" type="image/png" href="images/favicon.png">
		<title>Blog Title - Figuring out confusing assembly instructions &mdash; Koszek trick #2</title>
		<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
	</head>
	<body>
	<div class="container">
		<div class="row">
			<div id="debug">
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
				<div class="one column">&nbsp;</div>
			</div>
		</div>

		<div class="row">
			<div class="three columns logo">
				<a href="/">Wojciech Adam Koszek</a>
			</div>
			<div class="eight columns links">
				<a class="in" href="/">Writing</a>
				<a class="in" href="/reading/">Reading</a>
				<a class="in" href="/speaking/">Speaking</a>
				<a class="in" href="/software/">Software</a>
				<a class="in" href="/about/">About me</a>
			</div>
		</div>
		<div class="row">
			<div class="twelve columns">
				<br>
				<br>
			</div>
		</div>

		<div class="row"><!-- center -->
			<div class="three columns leftpanel">
				<div class="ads">
				</div>

				<b>Contact</b><br>
				<a href="mailto:wojciech@koszek.com"><i class="fa fa-envelope-o"></i>&nbsp;&nbsp;wojciech@koszek.com</a>
				<br>

				<a href="http://www.twitter.com/wkoszek/"><i class="fa fa-twitter"></i>&nbsp;&nbsp;@wkoszek</a>
				<br>

				<a href="http://www.linkedin.com/in/wkoszek/"><i class="fa fa-linkedin"></i>&nbsp;&nbsp;LinkedIn</a>
				<br>

				<a href="http://www.github.com/wkoszek/"><i class="fa fa-github"></i>&nbsp;&nbsp;Github</a>
				<br>

				<br>
				<b>Tags</b>
				<br>
					<a href="/blog/tags/books/">books (2)</a><br>
			</div>
			<div class="seven columns content">
				<p>Todays post will be very simple, maybe trivial. One of the hacks that I came
up with, when I encountered confusing arcane of ANSI C, or when I played
with assembly for fun and profit.</p>

<p>Problem: isolate ANSI C construct or in-line assembly block, so that upon a
translation to intermediate assembly, block will be exposed more easily in a
visual manner.</p>

<p>So imagine you want to isolate memory reference within ANSI C and figure out
what the corresponding assembly line is. Assume given portion of the code:</p>

<pre><code>[ptr.c]

#include &lt;stdio.h&gt;

int
main(int argc, char **argv)
{
	const char *str = "example";
	char	 c;

	(void)argc;
	(void)argv;

	__asm__("/* -------- BEGIN ----------- */");
	c = str[3];
	__asm__("/* --------  END  ----------- */");
	printf("%c\n", c);

	return 0;
}
</code></pre>

<p>Basically for a fixed literal string <code>example</code> you fetch its character <code>m</code>, which is
held in variable <code>c</code>. It doesn't make too much sense and isn't too useful,
but the technique has by all means real-world application.</p>

<p>Right now you perform:</p>

<pre><code>$ gcc -S ptr.c
</code></pre>

<p>And your created <code>ptr.s</code> suddenly has:</p>

<pre><code>	.file	"ptr.c"
	.section	.rodata
.LC0:
	.string	"example"
.LC1:
	.string	"%c\n"
	.text
.globl main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	pushq	%rbp
	.cfi_def_cfa_offset 16
	movq	%rsp, %rbp
	.cfi_offset 6, -16
	.cfi_def_cfa_register 6
	subq	$32, %rsp
	movl	%edi, -20(%rbp)
	movq	%rsi, -32(%rbp)
	movq	$.LC0, -16(%rbp)
#APP
# 12 "ptr.c" 1
	/* -------- BEGIN ----------- */
# 0 "" 2
#NO_APP
	movq	-16(%rbp), %rax
	addq	$3, %rax
	movzbl	(%rax), %eax
	movb	%al, -1(%rbp)
#APP
# 14 "ptr.c" 1
	/* --------  END  ----------- */
# 0 "" 2
#NO_APP
	movsbl	-1(%rbp), %edx
	movl	$.LC1, %eax
	movl	%edx, %esi
	movq	%rax, %rdi
	movl	$0, %eax
	call	printf
	movl	$0, %eax
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.ident	"GCC: (Ubuntu/Linaro 4.5.2-8ubuntu4) 4.5.2"
	.section	.note.GNU-stack,"",@progbits
</code></pre>

<p>As you can see, the comments placed by us through <code>__asm__</code> macro are
preserved in the intermediate assembly file. Ta-da!</p>

<p>If you have ever put a code, which has never been executed, or maybe even
disappeared somewhere deep in the sea of stages of compilation, this
technique should serve you well!
@@@RIGHT@@@</p>

<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&amp;bc1=FFFFFF&amp;IS2=1&amp;npa=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=000000&amp;t=wojcadamkoszh-20&amp;o=1&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=0131103628" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&amp;bc1=FFFFFF&amp;IS2=1&amp;npa=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=FF0000&amp;t=wojcadamkoszh-20&amp;o=1&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=0735619670" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&amp;bc1=FFFFFF&amp;IS2=1&amp;npa=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=FF0000&amp;t=wojcadamkoszh-20&amp;o=1&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=020161569X" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

			</div>

			<div class="two columns">
			</div>
		</div><!-- content -->

		<div class="row footer">
			<div class="twelve columns">
			<center>
				&copy; 2015 Wojciech Adam Koszek
			</center>
			</div>
		</div>
	</div><!--container-->
</body>
</html>
